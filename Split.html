<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chunker Pro - Revamped</title>
    <style>
        /* --- Google Fonts & Root Variables --- */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        :root {
            --font-primary: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --font-monospace: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;

            /* Light Theme */
            --bg-color: #f4f5f7;
            --surface-color: #ffffff;
            --surface-accent-color: #f9fafb;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
            --primary-color: #4f46e5;
            --primary-hover-color: #4338ca;
            --danger-color: #ef4444;
            --danger-hover-color: #dc2626;
            --success-color: #22c55e;
            --warning-color: #f59e0b;
            --info-color: #3b82f6;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --radius: 0.5rem;
        }

        .dark-mode {
            /* Dark Theme */
            --bg-color: #111827;
            --surface-color: #1f2937;
            --surface-accent-color: #374151;
            --text-primary: #f9fafb;
            --text-secondary: #9ca3af;
            --border-color: #374151;
            --primary-color: #6366f1;
            --primary-hover-color: #4f46e5;
        }

        /* --- Base & Reset --- */
        * { box-sizing: border-box; }
        body {
            font-family: var(--font-primary);
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            transition: background-color 0.2s, color 0.2s;
        }

        /* --- SVG Icons --- */
        .icon {
            width: 1.25em;
            height: 1.25em;
            stroke-width: 2;
            fill: none;
            stroke: currentColor;
        }

        /* --- Layout --- */
        .page-header {
            background-color: var(--surface-color);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .page-header h1 { font-size: 1.5rem; margin: 0; }
        .page-header .controls { display: flex; align-items: center; gap: 1rem; }

        .main-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
            padding: 1.5rem;
            max-width: 1800px;
            margin: 0 auto;
        }
        
        @media (min-width: 1024px) {
            .main-container {
                grid-template-columns: minmax(450px, 1fr) 1.5fr;
            }
        }

        .panel-sticky-top {
            position: sticky;
            top: 90px; /* Header height + padding */
            z-index: 50;
        }
        
        #output-column {
            max-height: calc(100vh - 110px);
            overflow-y: auto;
        }

        /* --- Card Component --- */
        .card {
            background-color: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            margin-bottom: 1.5rem;
        }
        .card-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }
        .card-header h3 { font-size: 1.1rem; margin: 0; }
        .card-content { padding: 1.25rem; }
        .card.collapsed .card-content { display: none; }
        .card-header .toggle-icon { transition: transform 0.2s; }
        .card.collapsed .toggle-icon { transform: rotate(-90deg); }

        /* --- Form Elements --- */
        label { display: block; font-weight: 500; margin-bottom: 0.5rem; }
        textarea, input[type="text"], input[type="number"], select {
            width: 100%;
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
            padding: 0.75rem;
            color: var(--text-primary);
            font-family: var(--font-monospace);
            font-size: 0.9rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        textarea:focus, input:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px color-mix(in srgb, var(--primary-color) 20%, transparent);
        }
        textarea { resize: vertical; min-height: 120px; }
        .form-group { margin-bottom: 1.25rem; }
        .form-group p.description {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin: 0.5rem 0 0;
            line-height: 1.5;
        }
        
        /* --- Buttons --- */
        .btn {
            display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;
            font-family: var(--font-primary); font-weight: 600; font-size: 0.95rem;
            padding: 0.65rem 1rem; border-radius: 0.375rem; border: 1px solid transparent;
            cursor: pointer; transition: all 0.2s; white-space: nowrap;
        }
        .btn:active { transform: scale(0.97); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:not(:disabled):hover { background-color: var(--primary-hover-color); }
        .btn-secondary { background-color: var(--surface-accent-color); color: var(--text-primary); border-color: var(--border-color); }
        .btn-secondary:not(:disabled):hover { background-color: color-mix(in srgb, var(--border-color) 50%, var(--surface-accent-color)); }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-danger:not(:disabled):hover { background-color: var(--danger-hover-color); }
        .btn-sm { padding: 0.4rem 0.8rem; font-size: 0.875rem; }
        .btn-icon { padding: 0.5rem; }
        .btn-block { width: 100%; }

        /* --- Mode Switcher --- */
        .mode-switcher { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; }
        .mode-switcher .btn {
            background-color: var(--surface-accent-color);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            font-weight: 500;
        }
        .mode-switcher .btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            box-shadow: var(--shadow-sm);
        }

        /* --- Specific Component Styling --- */
        /* JSON Input */
        .json-input-wrapper {
            position: relative;
            padding: 1rem;
            border: 2px dashed var(--border-color);
            border-radius: var(--radius);
            margin-bottom: 1rem;
            background-color: var(--bg-color);
            transition: border-color 0.2s, background-color 0.2s;
        }
        .json-input-wrapper.drag-over {
            border-color: var(--primary-color);
            background-color: color-mix(in srgb, var(--primary-color) 10%, var(--bg-color));
        }
        .json-input-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; gap: 0.5rem; }
        .json-input-header .title { font-weight: 600; color: var(--text-secondary); }
        #jsonInputsContainer .actions { display: flex; gap: 0.5rem; }

        /* Find & Replace */
        .find-replace-pair { display: grid; grid-template-columns: 1fr auto 1fr auto; gap: 0.75rem; align-items: center; margin-bottom: 0.75rem; }
        .find-replace-pair .arrow { color: var(--text-secondary); }
        #findReplacePairsContainer { max-height: 250px; overflow-y: auto; padding: 0.25rem; }

        /* Textarea Actions */
        .textarea-with-actions { position: relative; }
        .textarea-actions { position: absolute; top: 8px; right: 8px; display: flex; gap: 4px; }
        .textarea-actions .btn { background-color: var(--surface-color); opacity: 0.8; }

        /* Output Area */
        #outputControls {
            background-color: color-mix(in srgb, var(--surface-color) 80%, transparent);
            backdrop-filter: blur(8px);
            padding: 0.75rem 1rem;
            border-radius: var(--radius);
            border: 1px solid var(--border-color);
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }
        #outputControls h4 { margin: 0; color: var(--text-primary); font-size: 1.1rem; }
        
        .chunk-container {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 1rem;
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: 1rem;
            margin-bottom: 1rem;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        .chunk-container.copied {
            border-left: 4px solid var(--success-color);
            box-shadow: 0 0 15px color-mix(in srgb, var(--success-color) 10%, transparent);
        }
        .chunk-actions { grid-row: 1 / 3; display: flex; flex-direction: column; align-items: center; gap: 0.5rem; }
        .chunk-title { font-weight: 600; color: var(--primary-color); align-self: center; }
        .chunk-content textarea { min-height: 150px; background-color: var(--bg-color); }
        .copy-count-display { font-size: 0.8rem; color: var(--text-secondary); }
        .copy-button .tick { display: none; }
        .copy-button.copied-once .tick { display: inline; color: var(--success-color); }

        /* --- Status & Helpers --- */
        .status-message {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-size: 0.9rem;
            font-weight: 500;
            text-align: center;
            margin-top: 1rem;
        }
        .status-error { background-color: color-mix(in srgb, var(--danger-color) 15%, transparent); color: var(--danger-hover-color); }
        .dark-mode .status-error { color: #fca5a5; }
        .status-success { background-color: color-mix(in srgb, var(--success-color) 15%, transparent); color: #166534; }
        .dark-mode .status-success { color: #86efac; }

        #loadingIndicator {
            display: none; position: fixed; inset: 0;
            background-color: color-mix(in srgb, var(--surface-color) 50%, transparent);
            backdrop-filter: blur(4px);
            z-index: 1000;
            justify-content: center; align-items: center;
        }
        #loadingIndicator div {
            background-color: var(--surface-color); padding: 2rem; border-radius: var(--radius);
            box-shadow: var(--shadow-md); font-size: 1.2rem; font-weight: 500;
        }

        #scrollToTopBtn {
            display: none; position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: 99;
        }

    </style>
</head>
<body>

    <svg width="0" height="0" style="display: none;">
        <symbol id="icon-sun" viewBox="0 0 24 24"><path d="M12 1v2m-6.36 1.64l1.41 1.41M3.5 12h-2m1.64 6.36l1.41-1.41M12 21v2m6.36-1.64l-1.41-1.41M20.5 12h2m-1.64-6.36l-1.41 1.41M12 6a6 6 0 1 0 0 12 6 6 0 0 0 0-12z"></path></symbol>
        <symbol id="icon-moon" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></symbol>
        <symbol id="icon-chevron-down" viewBox="0 0 24 24"><path d="m6 9 6 6 6-6"></path></symbol>
        <symbol id="icon-copy" viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></symbol>
        <symbol id="icon-clipboard" viewBox="0 0 24 24"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></symbol>
        <symbol id="icon-trash" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></symbol>
        <symbol id="icon-plus" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></symbol>
        <symbol id="icon-check" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"></polyline></symbol>
        <symbol id="icon-refresh" viewBox="0 0 24 24"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></symbol>
    </svg>

    <header class="page-header">
        <h1>Chunker Pro</h1>
        <div class="controls">
            <button id="theme-toggle" class="btn btn-secondary btn-icon" title="Toggle Dark/Light Theme">
                <svg class="icon"><use href="#icon-moon"></use></svg>
            </button>
            <button id="resetAllButton" class="btn btn-danger btn-sm" title="Clear all settings and inputs">
                <svg class="icon"><use href="#icon-refresh"></use></svg>
                <span>Reset All</span>
            </button>
        </div>
    </header>

    <main class="main-container">
        <div id="settings-column">
            <div class="card">
                <div class="card-header">
                    <h3>1. Input Mode</h3>
                </div>
                <div class="card-content">
                    <div class="mode-switcher" id="modeSwitcher">
                        <button data-mode="json" class="btn active">JSON Objects</button>
                        <button data-mode="text" class="btn">Plain Text</button>
                    </div>
                    <input type="hidden" id="splitModeSelect" value="json">
                </div>
            </div>

            <div id="jsonModeSections">
                <div class="card">
                    <div class="card-header">
                        <h3>2. JSON Input Chapters</h3>
                        <span class="toggle-icon"><svg class="icon"><use href="#icon-chevron-down"></use></svg></span>
                    </div>
                    <div class="card-content">
                        <p class="description">Add one or more JSON arrays. You can also drag & drop .json files onto the boxes below.</p>
                        <div id="jsonInputsContainer"></div>
                        <div style="display:flex; align-items:center; gap:10px; margin-top:1rem;">
                            <button id="addJsonChapterButton" class="btn btn-primary btn-sm">
                                <svg class="icon"><use href="#icon-plus"></use></svg> Add Input
                            </button>
                            <span id="jsonObjectsCount" class="info-counter" style="margin-left: auto; font-size: 0.9rem; color: var(--text-secondary);">Total Objects: 0</span>
                        </div>
                         <div class="form-group" style="margin-top: 1.5rem;">
                            <label for="jsonObjectsPerChunk">Combine objects per chunk</label>
                            <select id="jsonObjectsPerChunk">
                                <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="10">10</option><option value="20">20</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>3. Find & Replace</h3>
                        <span class="toggle-icon"><svg class="icon"><use href="#icon-chevron-down"></use></svg></span>
                    </div>
                    <div class="card-content">
                        <p class="description">Applied to <code>object.terms[*].translation</code> during processing.</p>
                        <div style="display:flex; gap: 1rem; margin-bottom: 1rem;">
                            <label style="font-weight:normal;"><input type="checkbox" id="applyRulesCheckbox"> Apply Rules</label>
                            <label style="font-weight:normal;"><input type="checkbox" id="caseInsensitiveCheckbox"> Case-insensitive</label>
                        </div>
                        <div id="findReplacePairsContainer"></div>
                        <div style="margin-top:1rem;">
                            <button id="addFindReplacePairButton" class="btn btn-secondary btn-sm">
                                <svg class="icon"><use href="#icon-plus"></use></svg> Add Rule
                            </button>
                        </div>
                        <div id="glossaryReplaceStatus" style="margin-top: 1rem;"></div>
                    </div>
                </div>
            </div>
            
            <div id="plainTextModeSections" style="display:none;">
                 <div class="card">
                    <div class="card-header">
                        <h3>2. Plain Text Input</h3>
                         <span class="toggle-icon"><svg class="icon"><use href="#icon-chevron-down"></use></svg></span>
                    </div>
                    <div class="card-content">
                        <p class="description">Text will be split by max characters, intelligently breaking at sentence or word boundaries.</p>
                        <div class="form-group">
                            <textarea id="plainTextInputArea" placeholder="Paste or type plain text here..."></textarea>
                             <div style="text-align: right; margin-top: 0.5rem; font-size: 0.9rem; color: var(--text-secondary);" id="plainTextInfo">Chars: 0 / Approx. Chunks: 0</div>
                        </div>
                        <div class="form-group">
                            <label for="formatSelect">Format text (before splitting)</label>
                            <select id="formatSelect">
                                <option value="as-is">Show text as is</option>
                                <option value="pretty">Pretty (trim lines, join with double newlines)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="maxChars">Max characters per chunk</label>
                            <input type="number" id="maxChars" value="1800" min="1">
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 id="commonSectionHeader">4. Chunk Header & Footer</h3>
                    <span class="toggle-icon"><svg class="icon"><use href="#icon-chevron-down"></use></svg></span>
                </div>
                <div class="card-content">
                    <p class="description">Use <code>$X</code> for current part and <code>$Y</code> for total parts. <br><span id="headerFooterPreview" style="color: var(--primary-color); font-style: italic;"></span></p>
                    <div class="form-group">
                        <label for="addToTop">Header (prepended to each chunk)</label>
                        <textarea id="addToTop" placeholder="Text to add to the top..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="addToBottom">Footer (appended to each chunk)</label>
                        <textarea id="addToBottom" placeholder="Text to add to the bottom..." style="height:80px;"></textarea>
                    </div>
                </div>
            </div>

            <div class="panel-sticky-top">
                <button id="mainSplitButton" class="btn btn-primary btn-block" style="font-size: 1.1rem; padding: 0.8rem;">
                    Process & Split
                </button>
                <div id="processStatus"></div>
            </div>
        </div>

        <div id="output-column-wrapper" style="display:none;">
            <div class="panel-sticky-top">
                <div id="outputControls">
                    <h4 id="outputSummary">Output</h4>
                    <button id="copyNextButton" class="btn btn-sm" style="background-color: var(--warning-color); color: #422006; margin-left:auto;">Copy NEXT</button>
                    <button id="clearOutputButton" class="btn btn-secondary btn-sm">Clear Output</button>
                </div>
            </div>
            <div id="output-column">
                <div id="chunkedTextContainer"></div>
            </div>
        </div>
    </main>
    
    <div id="loadingIndicator"><div >Processing...</div></div>
    <button id="scrollToTopBtn" class="btn btn-primary btn-icon" onclick="window.scrollTo({top: 0, behavior: 'smooth'})" title="Go to top">
        <svg class="icon" style="transform: rotate(-90deg);"><use href="#icon-chevron-down"></use></svg>
    </button>
    

    <script>
    // --- State & Config ---
    let lastClickedButton = null;
    let jsonChapterInputIdCounter = 0;
    const STATE_KEY = 'chunkerAppState_V4_Revamped'; // New state key for the new UI
    const statusTimeouts = {};

    const newDefaultAddToTopPreset = `"Before replying YOU must think. From now onwards, in your thinking process/thought process/strategizing instead of YOU doing regular thinking, it is imperative that YOU MUST open and activate "Super-Duper-Hyper Thinking Mode". In this mode, you are obligated to: 1) engage in extreme exceptionally extreme thinking 2) engage in extreme exceptionally extreme extensivity 3) extreme exceptionally extreme extensity analysis"

1. Analyze raw Passage and Translation: 
   - FOR EACH line, summarize its meaning and compare it very thoroughly to the translation.
   - Note if the translation matches the original or deviates, explaining any ambiguities or potential errors.

2. Identify Errors:
  - Spot issues related to: Accuracy, Logic, Language.
  - Analyze every line thoroughly.

3. Verify Errors & Fix the Translation:
  - Correct the verified errors and use English major level proficiency to make the prose flows smoothly.
  - Do not use only colon and bullet points in your translation.
  - DO NOT transliterate honorifics unless the glossary says so.
  - Do not over condense sentences.

4. Give only the Fixed human like English translation as output and not the Whole JSON format.`;

    const defaultState = {
        theme: 'light',
        splitMode: 'json',
        maxChars: '1800',
        addToTop: newDefaultAddToTopPreset,
        addToBottom: '---\nEnd of Part $X of $Y',
        formatSelect: 'pretty',
        jsonObjectsPerChunk: '1',
        plainText: '',
        jsonInputs: [''],
        findReplacePairs: [{find:"", replace:""}],
        applyRules: false,
        caseInsensitive: false,
        collapsedSections: [],
    };
    let currentAppState = {...defaultState};

    // --- Helpers & Utilities ---
    const $ = (selector) => document.querySelector(selector);
    const $$ = (selector) => document.querySelectorAll(selector);

    function debounce(func, delay) {
        let timeout;
        return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), delay);
        };
    }
    const debouncedSaveState = debounce(saveState, 500);
    const debouncedUpdateTotalJsonObjectCount = debounce(updateTotalJsonObjectCount, 400);
    const debouncedUpdatePlainTextInfo = debounce(updatePlainTextInfo, 400);
    const debouncedUpdateHeaderFooterPreview = debounce(updateHeaderFooterPreview, 300);

    function showStatus(elementId, message, type = 'success', timeout = 4000) {
        const element = $(`#${elementId}`);
        if (!element) return;
        
        element.innerHTML = message;
        element.className = `status-message status-${type}`;
        element.style.display = 'block';

        if(statusTimeouts[elementId]) clearTimeout(statusTimeouts[elementId]);
        
        if (timeout > 0) {
            statusTimeouts[elementId] = setTimeout(() => {
                if(element) element.style.display = 'none';
                delete statusTimeouts[elementId];
            }, timeout);
        }
    }
    
    function showLoading() { $('#loadingIndicator').style.display = 'flex'; }
    function hideLoading() { $('#loadingIndicator').style.display = 'none'; }
    function escapeRegExp(string) { return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }
    
    // --- Theme Management ---
    function applyTheme(theme) {
        document.body.classList.toggle('dark-mode', theme === 'dark');
        const themeIcon = $('#theme-toggle .icon use');
        themeIcon.setAttribute('href', theme === 'dark' ? '#icon-sun' : '#icon-moon');
    }

    function toggleTheme() {
        currentAppState.theme = document.body.classList.contains('dark-mode') ? 'light' : 'dark';
        applyTheme(currentAppState.theme);
        saveState();
    }

    // --- State Management ---
    function saveState() {
       currentAppState.splitMode = $('#splitModeSelect').value;
       currentAppState.maxChars = $('#maxChars').value;
       currentAppState.addToTop = $('#addToTop').value;
       currentAppState.addToBottom = $('#addToBottom').value;
       currentAppState.formatSelect = $('#formatSelect').value;
       currentAppState.jsonObjectsPerChunk = $('#jsonObjectsPerChunk').value;
       currentAppState.plainText = $('#plainTextInputArea').value;
       currentAppState.applyRules = $('#applyRulesCheckbox').checked;
       currentAppState.caseInsensitive = $('#caseInsensitiveCheckbox').checked;
       currentAppState.jsonInputs = Array.from($$('#jsonInputsContainer textarea')).map(t => t.value);
       currentAppState.findReplacePairs = Array.from($$('#findReplacePairsContainer .find-replace-pair')).map(p => ({
           find: p.querySelector('.find-text')?.value || "",
           replace: p.querySelector('.replace-text')?.value || ""
       })).filter(p => p.find || p.replace);
       currentAppState.collapsedSections = Array.from($$('.card.collapsed')).map(fs => fs.querySelector('h3').textContent.trim());

       try {
           localStorage.setItem(STATE_KEY, JSON.stringify(currentAppState));
       } catch (e) {
           console.error("LocalStorage save failed:", e);
           // Non-intrusive error
       }
    }

   function loadState() {
       try {
          const savedStateJSON = localStorage.getItem(STATE_KEY);
           if (savedStateJSON) {
              const savedState = JSON.parse(savedStateJSON);
              currentAppState = { ...defaultState, ...savedState };
           }
        } catch (e) {
           console.error("LocalStorage load failed:", e);
        }
        
        applyTheme(currentAppState.theme);
        $('#splitModeSelect').value = currentAppState.splitMode;
        $('#maxChars').value = currentAppState.maxChars;
        $('#addToTop').value = currentAppState.addToTop;
        $('#addToBottom').value = currentAppState.addToBottom;
        $('#formatSelect').value = currentAppState.formatSelect;
        $('#jsonObjectsPerChunk').value = currentAppState.jsonObjectsPerChunk;
        $('#plainTextInputArea').value = currentAppState.plainText;
        $('#applyRulesCheckbox').checked = !!currentAppState.applyRules;
        $('#caseInsensitiveCheckbox').checked = !!currentAppState.caseInsensitive;
        
        if (currentAppState.collapsedSections) {
             $$('.card').forEach(fs => {
                const title = fs.querySelector('h3').textContent.trim();
                fs.classList.toggle('collapsed', currentAppState.collapsedSections.includes(title));
             });
        }
        
        $('#jsonInputsContainer').innerHTML = '';
        jsonChapterInputIdCounter = 0;
        (currentAppState.jsonInputs?.length > 0 ? currentAppState.jsonInputs : ['']).forEach(content => addJsonChapterInput(content, false));
        
        $('#findReplacePairsContainer').innerHTML = '';
        (currentAppState.findReplacePairs?.length > 0 ? currentAppState.findReplacePairs : [{find:"", replace:""}]).forEach(pair => addFindReplacePair(pair.find, pair.replace, false));
   }
   
    function resetAllToDefaults() {
         if(confirm("Are you sure you want to clear all inputs and settings? This will reload the page.")) {
            localStorage.removeItem(STATE_KEY);
            window.location.reload();
         }
    }
    
    // --- UI Element Management ---
    function toggleInputSections() {
        const splitMode = $('#splitModeSelect').value;

        $$('.mode-switcher .btn').forEach(btn => btn.classList.toggle('active', btn.dataset.mode === splitMode));
        $('#jsonModeSections').style.display = (splitMode === 'json' ? 'block' : 'none');
        $('#plainTextModeSections').style.display = (splitMode === 'text' ? 'block' : 'none');
        $('#commonSectionHeader').textContent = (splitMode === 'json' ? '4. Chunk Header & Footer' : '3. Chunk Header & Footer');
        
        clearOutput();
        splitMode === 'json' ? updateTotalJsonObjectCount() : updatePlainTextInfo();
        debouncedSaveState();
    }
    
    // --- JSON Input Management (with Drag & Drop) ---
    function addJsonChapterInput(content = '', save = true) {
        jsonChapterInputIdCounter++;
        const container = $('#jsonInputsContainer');
        const chapterDiv = document.createElement('div');
        chapterDiv.className = 'json-input-wrapper';
        chapterDiv.innerHTML = `
         <div class="json-input-header">
            <span class="title">JSON Input #${jsonChapterInputIdCounter}</span>
            <div class="actions">
                <button type="button" class="btn btn-secondary btn-sm btn-icon remove-json-btn" title="Remove">
                    <svg class="icon"><use href="#icon-trash"></use></svg>
                </button>
            </div>
         </div>
         <textarea placeholder='Paste JSON array here or drop a .json file...' class="json-chapter-input">${content}</textarea>
         <div class="status-message" style="display: none; margin-top: 0.5rem; padding: 0.25rem 0.5rem;"></div>`;
        
        // Add event listeners
        const textarea = chapterDiv.querySelector('textarea');
        const statusSpan = chapterDiv.querySelector('.status-message');
        textarea.addEventListener('input', () => {
            updateIndividualJsonCount(textarea, statusSpan);
            debouncedUpdateTotalJsonObjectCount();
            debouncedSaveState();
        });
        chapterDiv.querySelector('.remove-json-btn').addEventListener('click', () => removeJsonChapterInput(chapterDiv));
        
        // Drag and Drop listeners
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => chapterDiv.addEventListener(eventName, preventDefaults, false));
        ['dragenter', 'dragover'].forEach(eventName => {
            chapterDiv.addEventListener(eventName, () => chapterDiv.classList.add('drag-over'), false);
        });
        ['dragleave', 'drop'].forEach(eventName => {
            chapterDiv.addEventListener(eventName, () => chapterDiv.classList.remove('drag-over'), false);
        });
        chapterDiv.addEventListener('drop', handleDrop, false);

        container.appendChild(chapterDiv);
        updateIndividualJsonCount(textarea, statusSpan);
        if (save) {
            updateTotalJsonObjectCount();
            debouncedSaveState();
        }
    }

    function removeJsonChapterInput(element) {
        element.remove();
        updateTotalJsonObjectCount();
        if ($$('#jsonInputsContainer .json-input-wrapper').length === 0) {
            addJsonChapterInput('', false);
        }
        debouncedSaveState();
    }
    
    function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }

    function handleDrop(e) {
        const dt = e.dataTransfer;
        const file = dt.files[0];
        const textarea = e.currentTarget.querySelector('textarea');
        const statusSpan = e.currentTarget.querySelector('.status-message');

        if (file && file.type === "application/json") {
            const reader = new FileReader();
            reader.onload = (readEvent) => {
                textarea.value = readEvent.target.result;
                textarea.dispatchEvent(new Event('input', { bubbles: true })); // Trigger updates
            };
            reader.readAsText(file);
        } else {
            statusSpan.textContent = 'Error: Please drop a .json file.';
            statusSpan.className = 'status-message status-error';
            statusSpan.style.display = 'block';
        }
    }

    function updateIndividualJsonCount(textarea, statusSpan) {
        const jsonString = textarea.value.trim();
        if (!jsonString) {
            statusSpan.style.display = 'none';
            return;
        }
        try {
            if (!jsonString.startsWith('[')) throw new Error("Must be an Array []");
            const jsonData = JSON.parse(jsonString);
            if (!Array.isArray(jsonData)) throw new Error("Must be an Array []");
            statusSpan.textContent = `Valid Array with ${jsonData.length} objects.`;
            statusSpan.className = 'status-message status-success';
            statusSpan.style.display = 'block';
        } catch (e) {
            statusSpan.textContent = `Error: ${e.message}`;
            statusSpan.className = 'status-message status-error';
            statusSpan.style.display = 'block';
        }
    }

    function updateTotalJsonObjectCount() {
        let totalObjects = 0;
        $$('#jsonInputsContainer textarea.json-chapter-input').forEach(textarea => {
             const jsonString = textarea.value.trim();
             try {
                 if (jsonString.startsWith('[') && jsonString.endsWith(']')) {
                    const jsonData = JSON.parse(jsonString);
                    if (Array.isArray(jsonData)) totalObjects += jsonData.length;
                 }
             } catch (e) { /* ignore */ }
        });
        $('#jsonObjectsCount').textContent = `Total Objects: ${totalObjects}`;
    }

    // --- Find/Replace, Plain Text, Common UI ---
    function addFindReplacePair(findVal = "", replaceVal = "", save=true) {
        const container = $('#findReplacePairsContainer');
        const pairDiv = document.createElement('div');
        pairDiv.className = 'find-replace-pair';
        pairDiv.innerHTML = `
            <input type="text" class="find-text" placeholder="Find" value="${findVal}">
            <span class="arrow">â†’</span>
            <input type="text" class="replace-text" placeholder="Replace" value="${replaceVal}">
            <button type="button" class="btn btn-secondary btn-sm btn-icon">
                 <svg class="icon"><use href="#icon-trash"></use></svg>
            </button>`;
        pairDiv.querySelector('button').addEventListener('click', () => removeFindReplacePair(pairDiv));
        pairDiv.querySelectorAll('input').forEach(input => input.addEventListener('input', debouncedSaveState));
        container.appendChild(pairDiv);
        if(save) debouncedSaveState();
    }

    function removeFindReplacePair(element) {
        element.remove();
        if ($$('#findReplacePairsContainer .find-replace-pair').length === 0) {
             addFindReplacePair("","", false);
        }
        debouncedSaveState();
    }

    function updatePlainTextInfo() {
        const text = $('#plainTextInputArea').value;
        const maxChars = parseInt($('#maxChars').value, 10);
        const charCount = text.length;
        const chunks = (charCount > 0 && maxChars > 0) ? Math.ceil(charCount / maxChars) : (charCount > 0 ? 1 : 0);
        $('#plainTextInfo').textContent = `Chars: ${charCount} / Approx. Chunks: ${chunks}`;
    }

    function formatPlainText() {
      const formatSelect = $('#formatSelect').value;
      const textArea = $('#plainTextInputArea');
      if (formatSelect === 'pretty') {
         textArea.value = currentAppState.plainText.split('\n').map(p => p.trim()).filter(p => p).join('\n\n');
      } else {
         textArea.value = currentAppState.plainText;
      }
       updatePlainTextInfo();
       debouncedSaveState();
    }

    function updateHeaderFooterPreview() {
        const top = $('#addToTop').value;
        const bottom = $('#addToBottom').value;
        let preview = '';
        if(top) preview += `Preview: "${top.replace(/\$X/g, '1').replace(/\$Y/g, 'N').substring(0, 30)}..."`;
        if(bottom) preview += ` ... "${bottom.replace(/\$X/g, '1').replace(/\$Y/g, 'N')}"`;
        $('#headerFooterPreview').textContent = preview;
    }
    
    // --- Core Logic (largely unchanged) ---
    function processAndChunk() {
       clearOutput();
       showLoading();
       setTimeout(() => {
        try {
          const splitMode = $('#splitModeSelect').value;
          const addToTop = $('#addToTop').value;
          const addToBottom = $('#addToBottom').value;
          const container = $('#chunkedTextContainer');
          let chunkCount = 0;
          
          if (splitMode === 'json') {
             const { data, success, allEmpty } = getAllCombinedJsonData();
             if (allEmpty) throw new Error("All JSON inputs are empty.");
             if (!success) throw new Error("Invalid JSON found. See errors on input boxes.");
             const { data: processedJsonData, count: replacementCount } = applyGlossaryRules(data);
             if (replacementCount > 0) {
                showStatus('glossaryReplaceStatus', `Applied ${replacementCount} replacements.`, 'success', 5000);
             } else if ($('#applyRulesCheckbox').checked) {
                showStatus('glossaryReplaceStatus', `No matching terms found to replace.`, 'info', 5000);
             }
             chunkCount = chunkJsonInput(processedJsonData, addToTop, addToBottom, container);
          } else {
             const text = $('#plainTextInputArea').value;
             const maxChars = parseInt($('#maxChars').value);
             if (!text.trim()) throw new Error("Plain text input is empty.");
             if (isNaN(maxChars) || maxChars <= 0) throw new Error("Max characters must be > 0.");
             chunkCount = chunkPlainTextInput(text, maxChars, addToTop, addToBottom, container);
          }
           if (chunkCount > 0) {
                $('#output-column-wrapper').style.display = 'block';
                $('#outputSummary').textContent = `Output: ${chunkCount} Chunk${chunkCount === 1 ? '' : 's'}`;
                $('#copyNextButton').disabled = false;
                showStatus('processStatus', `<div class="status-message status-success">Success: Generated ${chunkCount} chunks.</div>`, 'success', 0);
           } else {
                throw new Error("No chunks were generated from the input.");
           }
        } catch (error) {
           showStatus('processStatus', `<div class="status-message status-error">${error.message}</div>`, 'error', 0);
        } finally {
          hideLoading();
        }
      }, 50);
    }
    
    function getAllCombinedJsonData() {
        let combinedData = [], allInputsValid = true, allEmpty = true;
        $$('#jsonInputsContainer textarea.json-chapter-input').forEach(textarea => {
            const jsonString = textarea.value.trim();
            if (!jsonString) return;
            allEmpty = false;
            try {
                if (!jsonString.startsWith('[')) throw new Error();
                const jsonData = JSON.parse(jsonString);
                if (Array.isArray(jsonData)) {
                    combinedData = combinedData.concat(jsonData);
                } else { throw new Error(); }
            } catch (e) { allInputsValid = false; }
        });
        return { data: combinedData, success: allInputsValid, allEmpty };
    }

    function applyGlossaryRules(jsonData) {
        if (!$('#applyRulesCheckbox').checked || !jsonData || jsonData.length === 0) {
            return { data: jsonData, count: 0 };
        }
        const flags = $('#caseInsensitiveCheckbox').checked ? 'gi' : 'g';
        const rules = currentAppState.findReplacePairs.map(p => {
             if (!p.find) return null;
             try { return { findRegExp: new RegExp(escapeRegExp(p.find), flags), replace: p.replace }; }
             catch (e) { return null; }
        }).filter(Boolean);

        if (rules.length === 0) return { data: jsonData, count: 0 };
        
        const processedData = JSON.parse(JSON.stringify(jsonData)); // Deep copy
        let totalInstancesReplaced = 0;

        processedData.forEach(obj => {
            if (obj && Array.isArray(obj.terms)) {
                obj.terms.forEach(term => {
                    if (term && typeof term.translation === 'string') {
                        rules.forEach(rule => {
                            const matches = term.translation.match(rule.findRegExp);
                            if(matches) {
                                totalInstancesReplaced += matches.length;
                                term.translation = term.translation.replace(rule.findRegExp, rule.replace);
                            }
                        });
                    }
                });
            }
        });
        return { data: processedData, count: totalInstancesReplaced };
    }
    
    function chunkJsonInput(jsonData, addToTop, addToBottom, container) {
        const objectsToGroup = parseInt($('#jsonObjectsPerChunk').value, 10) || 1;
        const totalChunks = Math.ceil(jsonData.length / objectsToGroup);
        for (let i = 0; i < jsonData.length; i += objectsToGroup) {
            const group = jsonData.slice(i, i + objectsToGroup);
            const partNum = (i / objectsToGroup) + 1;
            const title = `Seg ${partNum}/${totalChunks} (Items ${i + 1}-${i + group.length})`;
            const content = JSON.stringify(objectsToGroup === 1 && group.length === 1 ? group[0] : group, null, 2);
            const top = addToTop.replace(/\$X/g, partNum).replace(/\$Y/g, totalChunks);
            const bottom = addToBottom.replace(/\$X/g, partNum).replace(/\$Y/g, totalChunks);
            displayChunk([top, content, bottom].filter(Boolean).join('\n\n'), title, container, partNum);
        }
        return totalChunks;
    }
    
    function smartSplit(text, maxLength) {
        if (text.length <= maxLength) return [text];
        const chunks = []; let currentText = text;
        const breakChars = ['. ', '! ', '? ', '\n', ' ', ','];
        while (currentText.length > maxLength) {
            let breakPoint = -1;
            for(const char of breakChars) {
                const index = currentText.lastIndexOf(char, maxLength);
                if(index !== -1) { breakPoint = index + (char.trim() ? char.length : 0); break; }
            }
            if (breakPoint === -1) breakPoint = maxLength;
            chunks.push(currentText.substring(0, breakPoint).trim());
            currentText = currentText.substring(breakPoint).trim();
        }
        if (currentText) chunks.push(currentText);
        return chunks;
    }
    
    function chunkPlainTextInput(text, maxChars, addToTop, addToBottom, container) {
       let chunks = []; let currentChunk = "";
       text.split('\n').forEach(paragraph => {
           if (paragraph.length > maxChars) {
               if (currentChunk) chunks.push(currentChunk);
               chunks.push(...smartSplit(paragraph, maxChars));
               currentChunk = "";
               return;
           }
           if (currentChunk && (currentChunk.length + paragraph.length + 1 > maxChars)) {
                chunks.push(currentChunk);
                currentChunk = paragraph;
           } else {
               currentChunk = currentChunk ? `${currentChunk}\n${paragraph}` : paragraph;
           }
       });
       if (currentChunk) chunks.push(currentChunk);
       chunks = chunks.map(c => c.trim()).filter(Boolean);
       const totalChunks = chunks.length;
       chunks.forEach((chunk, index) => {
         const partNum = index + 1;
         const top = addToTop.replace(/\$X/g, partNum).replace(/\$Y/g, totalChunks);
         const bottom = addToBottom.replace(/\$X/g, partNum).replace(/\$Y/g, totalChunks);
         displayChunk([top, chunk, bottom].filter(Boolean).join('\n\n'), `Part ${partNum}/${totalChunks}`, container, partNum);
       });
       return totalChunks;
    }
    
    // --- Output & Copying ---
    function displayChunk(content, title, container, partNum) {
        const chunkDiv = document.createElement('div');
        chunkDiv.className = 'chunk-container';
        chunkDiv.dataset.copied = "false";
        chunkDiv.dataset.part = partNum;
        chunkDiv.innerHTML = `
         <div class="chunk-actions">
            <button class="btn btn-primary btn-icon copy-button" data-copy-count="0" title="Copy">
                <svg class="icon"><use href="#icon-copy"></use></svg>
                <svg class="icon tick"><use href="#icon-check"></use></svg>
            </button>
            <span class="copy-count-display">(0)</span>
         </div>
         <div class="chunk-title">${title}</div>
         <div class="chunk-content">
             <textarea readonly>${content}</textarea>
         </div>`;
        const copyButton = chunkDiv.querySelector('.copy-button');
        copyButton.addEventListener('click', () => copyToClipboard(
            chunkDiv.querySelector('textarea').value, 
            copyButton,
            chunkDiv.querySelector('.copy-count-display')
        ));
        container.appendChild(chunkDiv);
    }
    
    function clearOutput() {
        $('#chunkedTextContainer').innerHTML = '';
        $('#output-column-wrapper').style.display = 'none';
        $('#processStatus').innerHTML = '';
        $('#glossaryReplaceStatus').innerHTML = '';
        lastClickedButton = null;
    }
    
    function copyToClipboard(text, buttonEl, countEl) {
       navigator.clipboard.writeText(text).then(() => {
            if (lastClickedButton && lastClickedButton !== buttonEl) {
                lastClickedButton.classList.remove('copied-once');
            }
            buttonEl.classList.add('copied-once');
            lastClickedButton = buttonEl;

            const container = buttonEl.closest('.chunk-container');
            container.dataset.copied = "true";
            container.classList.add('copied');
            
            let count = parseInt(buttonEl.dataset.copyCount, 10) + 1;
            buttonEl.dataset.copyCount = count;
            countEl.textContent = `(${count})`;

            if (!$('.chunk-container[data-copied="false"]')) {
                $('#copyNextButton').disabled = true;
            }
        }).catch(err => { showStatus('processStatus', `<div class="status-message status-error">Failed to copy text.</div>`, 'error'); });
    }
    
    function copyNextUncopied() {
        const nextContainer = $('.chunk-container[data-copied="false"]');
        if(nextContainer) {
            nextContainer.querySelector('.copy-button').click();
            nextContainer.scrollIntoView({behavior: 'smooth', block: 'center'});
        }
    }
    
    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
        loadState();
        
        // Event Listeners
        $('#theme-toggle').addEventListener('click', toggleTheme);
        $('#resetAllButton').addEventListener('click', resetAllToDefaults);
        $('#mainSplitButton').addEventListener('click', processAndChunk);
        
        $('#modeSwitcher').addEventListener('click', (e) => {
            if (e.target.closest('button')) {
                $('#splitModeSelect').value = e.target.closest('button').dataset.mode;
                toggleInputSections();
            }
        });
        
        $$('.card-header').forEach(header => {
            header.addEventListener('click', (e) => {
                if (e.target.closest('button')) return; // ignore button clicks in header
                header.parentElement.classList.toggle('collapsed');
                debouncedSaveState();
            });
        });

        $('#addJsonChapterButton').addEventListener('click', () => addJsonChapterInput());
        $('#addFindReplacePairButton').addEventListener('click', () => addFindReplacePair());
        
        // Listen to any input/change/check and save state
        $('#jsonObjectsPerChunk').addEventListener('change', debouncedSaveState);
        $('#applyRulesCheckbox').addEventListener('change', debouncedSaveState);
        $('#caseInsensitiveCheckbox').addEventListener('change', debouncedSaveState);
        $('#plainTextInputArea').addEventListener('input', () => {
            currentAppState.plainText = $('#plainTextInputArea').value;
            debouncedUpdatePlainTextInfo();
            debouncedSaveState();
        });
        $('#maxChars').addEventListener('input', debouncedUpdatePlainTextInfo);
        $('#formatSelect').addEventListener('change', formatPlainText);
        $('#addToTop').addEventListener('input', () => {
            debouncedUpdateHeaderFooterPreview();
            debouncedSaveState();
        });
        $('#addToBottom').addEventListener('input', () => {
            debouncedUpdateHeaderFooterPreview();
            debouncedSaveState();
        });
        
        $('#clearOutputButton').addEventListener('click', clearOutput);
        $('#copyNextButton').addEventListener('click', copyNextUncopied);
        
        // Scroll to top button visibility
        const outputCol = $('#output-column');
        const SUTBtn = $("#scrollToTopBtn");
        if (outputCol) {
            outputCol.onscroll = () => {
                SUTBtn.style.display = outputCol.scrollTop > 200 ? "block" : "none";
            };
        }

        // Final UI Setup
        toggleInputSections();
        updateHeaderFooterPreview();
        clearOutput();
    });
    </script>
</body>
</html>
