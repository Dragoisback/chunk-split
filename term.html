<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zenith Term Processor v5.3</title> <!-- Version Bump -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"> <!-- Version bump for FA -->
    <style>
        :root {
            --bg-main: #f0f4f8; /* Slightly cooler background */
            --bg-panel: #ffffff;
            --primary-500: #3b82f6; /* Blue 500 */
            --primary-600: #2563eb; /* Blue 600 */
            --primary-700: #1d4ed8; /* Blue 700 */
            --secondary-500: #8b5cf6; /* Violet 500 */
            --secondary-600: #7c3aed; /* Violet 600 */
            --success-500: #10b981; /* Emerald 500 */
            --danger-500: #ef4444;  /* Red 500 */
            --danger-600: #dc2626;  /* Red 600 for hover */
            --warning-500: #f59e0b; /* Amber 500 */
            --warning-700: #b45309; /* Amber 700 for text */
            --neutral-800: #1f2937; /* Gray 800 for titles */
            --neutral-700: #374151; /* Gray 700 for text */
            --neutral-500: #6b7280; /* Gray 500 for secondary text */
            --neutral-300: #d1d5db; /* Gray 300 for borders */
            --neutral-200: #e5e7eb; /* Gray 200 for light borders/dividers */
            --neutral-100: #f3f4f6; /* Gray 100 for light backgrounds */
            --font-sans: 'Inter', sans-serif;
            --radius-md: 0.375rem; /* 6px */
            --radius-lg: 0.5rem;   /* 8px */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
            --transition-base: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        *, ::before, ::after { box-sizing: border-box; border-width: 0; border-style: solid; border-color: var(--neutral-300); }
        html { font-family: var(--font-sans); font-size: 16px; line-height: 1.5; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;}
        body { margin: 0; background-color: var(--bg-main); color: var(--neutral-700); padding: 1.5rem; }

        .app-container { max-width: 1400px; margin-left: auto; margin-right: auto; }

        .app-title-bar {
            margin-bottom: 2rem; text-align: center; padding: 1.5rem 1rem;
            background: linear-gradient(135deg, var(--primary-600), var(--secondary-600));
            color: white; border-radius: var(--radius-lg); box-shadow: var(--shadow-lg);
        }
        .app-title-bar h1 { font-size: 2rem; font-weight: 700; letter-spacing: -0.025em;}
        .app-title-bar p { font-size: 0.9rem; opacity: 0.9; margin-top: 0.25rem; }

        .grid-layout { display: grid; gap: 1.5rem; }
        @media (min-width: 1024px) { /* Large screens */
            .grid-layout { grid-template-columns: repeat(3, 1fr); }
            .grid-layout .col-span-1 { grid-column: span 1 / span 1; }
            .grid-layout .col-span-2 { grid-column: span 2 / span 2; }
            .grid-layout .col-span-3 { grid-column: span 3 / span 3; }
        }
         @media (min-width: 768px) and (max-width: 1023px) { /* Medium screens */
            .grid-layout { grid-template-columns: repeat(2, 1fr); }
            .grid-layout .md-col-span-1 { grid-column: span 1 / span 1; }
            .grid-layout .md-col-span-2 { grid-column: span 2 / span 2; }
        }
        /* Default (small screens) is single column for all panels */

        .panel { background-color: var(--bg-panel); border-radius: var(--radius-lg); box-shadow: var(--shadow-md); padding: 1.5rem; }
        .panel-title { display: flex; align-items: center; font-size: 1.25rem; font-weight: 600; margin-bottom: 1.25rem; padding-bottom: 0.75rem; border-bottom: 1px solid var(--neutral-200); color: var(--neutral-800); }
        .panel-title i { margin-right: 0.75rem; color: var(--primary-500); font-size:1.2em; }
        
        .form-group { margin-bottom: 1.25rem; }
        .form-label { display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.375rem; color: var(--neutral-500); }
        
        input[type="text"], textarea, .file-input-wrapper {
            width: 100%; padding: 0.625rem 0.875rem; border-radius: var(--radius-md);
            font-size: 0.875rem; background-color: white; border: 1px solid var(--neutral-300);
            transition: var(--transition-base); color: var(--neutral-700);
        }
        input[type="text"]:focus, textarea:focus {
            outline: 2px solid transparent; outline-offset: 2px;
            border-color: var(--primary-500); box-shadow: 0 0 0 3px rgba(59,130,246,0.3); 
        }
        textarea { resize: vertical; min-height: 80px; }

        .file-input-wrapper { position: relative; display: block; }
        .file-input-wrapper input[type="file"] { position: absolute; inset: 0; opacity: 0; width: 100%; height: 100%; cursor: pointer; }
        .file-input-wrapper .file-display-text { color: var(--neutral-500); }
        .file-input-wrapper .file-display-text.has-file { color: var(--neutral-700); font-weight: 500; }
        .file-input-wrapper i { color: var(--secondary-500); margin-right: 0.5rem; }
        
        .btn-group { display: flex; flex-wrap: wrap; gap: 0.625rem; margin-top: 0.75rem; }
        .btn {
            padding: 0.6rem 1.1rem; border-radius: var(--radius-md); font-size: 0.875rem; font-weight: 500;
            transition: var(--transition-base); display: inline-flex; align-items: center; justify-content: center;
            gap: 0.4rem; cursor: pointer; line-height: 1.25rem; text-decoration: none;
            box-shadow: var(--shadow-sm); border: 1px solid transparent;
        }
        .btn:hover { transform: translateY(-1px); box-shadow: var(--shadow-md); }
        .btn:focus-visible { outline: 2px solid transparent; outline-offset: 2px; box-shadow: 0 0 0 3px rgba(59,130,246,0.4); }
        .btn i { font-size:0.9em; }

        .btn-primary { background-color: var(--primary-500); color: white; }
        .btn-primary:hover { background-color: var(--primary-600); }
        .btn-secondary { background-color: var(--secondary-500); color: white; }
        .btn-secondary:hover { background-color: var(--secondary-600); }
        .btn-danger { background-color: var(--danger-500); color: white; }
        .btn-danger:hover { background-color: var(--danger-600); }
        .btn-outline { background-color: transparent; border-color: var(--neutral-300); color: var(--neutral-500); }
        .btn-outline:hover { background-color: var(--neutral-100); border-color: var(--neutral-500); color:var(--neutral-700); }
        .btn-outline.btn-danger { color: var(--danger-500); border-color: var(--danger-500); }
        .btn-outline.btn-danger:hover { background-color: var(--danger-500); color:white; }

        .btn-icon { padding: 0.5rem; }
        .btn-main-action { 
            padding: 0.75rem 1.5rem; font-size: 1rem; font-weight: 600;
            background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
        }
        .btn-main-action:hover {
             background: linear-gradient(135deg, var(--primary-600), var(--primary-700));
        }
        .btn-main-action .spinner { display: none; width: 1.125rem; height: 1.125rem; border: 2px solid rgba(255,255,255,0.4); border-radius: 50%; border-top-color: white; animation: spin 0.7s linear infinite; margin-right: 0.5rem;}
        .btn-main-action.loading .spinner { display: inline-block; }

        @keyframes spin { to { transform: rotate(360deg); } }

        #chapterInputsContainer {
            scrollbar-width: thin; /* Firefox */
            scrollbar-color: var(--neutral-300) var(--neutral-100); /* Firefox */
        }
        #chapterInputsContainer::-webkit-scrollbar { width: 8px; }
        #chapterInputsContainer::-webkit-scrollbar-track { background: var(--neutral-100); border-radius: 4px;}
        #chapterInputsContainer::-webkit-scrollbar-thumb { background-color: var(--neutral-300); border-radius: 4px; border: 2px solid var(--neutral-100); }
        #chapterInputsContainer::-webkit-scrollbar-thumb:hover { background-color: var(--neutral-500); }


        .chapter-input-group { margin-bottom: 1rem; padding: 1rem; border: 1px dashed var(--neutral-300); border-radius: var(--radius-md); background-color: rgba(243,244,246,0.5); } 
        .chapter-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
        .chapter-label { font-weight: 500; font-size:0.9rem; color: var(--secondary-500);}

        .status-message {
            margin-top: 0.75rem; padding: 0.85rem 1.1rem; border-radius: var(--radius-md); font-size: 0.875rem;
            display: flex; align-items: center; gap: 0.6rem; border: 1px solid;
        }
        .status-message i { font-size: 1.2em; }
        .status-success { background-color: #e0f2f1; color: #00796b; border-color: #a7d8c8; } /* Teal-like */
        .status-warning { background-color: #fff8e1; color: var(--warning-700); border-color: #ffecb3; } 
        .status-danger  { background-color: #ffebee; color: #c62828; border-color: #ffcdd2; } 
        .status-info    { background-color: #e3f2fd; color: #1565c0; border-color: #bbdefb; } 

        .storage-actions-group {
            margin-top:1rem; padding-top: 1rem; border-top: 1px solid var(--neutral-200);
        }
        .storage-actions-group .form-label { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--neutral-500); margin-bottom: 0.5rem;}


        #processingLog { border: 1px solid var(--neutral-200); background-color: var(--neutral-100); }
        #processingLog strong { color: var(--neutral-700); }
        #processingLog ul { list-style: none; padding: 0; margin:0.5rem 0 0 0; max-height: 150px; overflow-y: auto; font-size: 0.8rem; color:var(--neutral-500);}
        #processingLog li { padding: 0.35rem 0.5rem; border-bottom: 1px solid var(--neutral-200);}
        #processingLog li:last-child { border-bottom: none;}
        #processingLog li i { font-size: 0.9em; margin-right: 0.5rem; opacity: 0.8;}

        .output-actions { display: flex; justify-content: flex-end; gap: 0.75rem; margin-bottom: 0.75rem; }

        /* Modal Styles */
        .modal-overlay { position: fixed; inset: 0; background-color: rgba(17, 24, 39, 0.7); display: none; align-items: center; justify-content: center; z-index: 50; backdrop-filter: blur(5px); }
        .modal-overlay.active { display: flex; }
        .modal-content { background-color: var(--bg-panel); padding: 2rem; border-radius: var(--radius-lg); box-shadow: var(--shadow-lg); width: 90%; max-width: 500px; text-align: center; }
        .modal-title { font-size: 1.375rem; font-weight: 600; margin-bottom: 0.75rem; color: var(--neutral-800);}
        .modal-body { font-size: 0.9rem; color: var(--neutral-500); margin-bottom: 1.75rem; line-height: 1.6;}
        .modal-actions { display: flex; flex-wrap: wrap; justify-content: center; gap: 0.75rem; }

        .tooltip { position: relative; display: inline-block; }
        .tooltip .tooltip-text {
            visibility: hidden; background-color: var(--neutral-800); color: white; text-align: center;
            border-radius: var(--radius-md); padding: 0.375rem 0.75rem; position: absolute; z-index: 1;
            bottom: 125%; left: 50%; transform: translateX(-50%); opacity: 0; transition: opacity 0.2s;
            font-size: 0.75rem; white-space: nowrap; box-shadow: var(--shadow-md);
        }
        .tooltip:hover .tooltip-text { visibility: visible; opacity: 1; }

        .session-config-grid-internal {
            display: grid;
            gap: 1rem;
            grid-template-columns: 1fr; 
        }
        @media (min-width: 500px) { 
            .session-config-grid-internal {
                grid-template-columns: 1fr 1fr;
            }
        }

    </style>
</head>
<body>
    <div class="app-container">
        <header class="app-title-bar">
            <h1><i class="fas fa-microchip"></i> Zenith Term Processor v5.3</h1> <!-- Updated Icon -->
            <p>Intelligent Term Extraction with Persistent Project Deduplication</p>
        </header>

        <div class="grid-layout">
            <!-- Project Setup Panel -->
            <div class="panel col-span-1 md-col-span-1">
                <h2 class="panel-title"><i class="fas fa-folder-tree"></i>Project Setup & Storage</h2>
                <div class="form-group">
                    <label for="novelNameInput" class="form-label">Novel/Project Name:</label>
                    <input type="text" id="novelNameInput" placeholder="E.g., My Awesome Novel">
                    <small class="form-label" style="margin-top:4px;font-size:0.75rem;">This name is used for storing deduplication data.</small>
                </div>
                <div id="storedTermsInfo" class="status-message status-info" style="display:none; font-size:0.8rem; flex-direction: column; align-items: flex-start;"></div>
                
                <div class="storage-actions-group">
                    <h3 class="form-label">Storage Actions</h3>
                    <div class="btn-group" style="flex-direction: column; gap: 0.5rem;">
                        <button id="loadStoredBtn" onclick="loadPersistentDedupe()" class="btn btn-outline" style="width:100%;">
                            <i class="fas fa-cloud-download-alt"></i>Load Stored for Project
                        </button>
                        <button id="clearStoredBtn" onclick="confirmClearStorage()" class="btn btn-outline btn-danger" style="width:100%;">
                            <i class="fas fa-trash-alt"></i>Clear Storage for Project
                        </button>
                         <div style="display: flex; gap: 0.5rem; width:100%; margin-top:0.25rem;">
                            <button id="exportStoredBtn" onclick="exportPersistentDedupe()" class="btn btn-outline" style="flex-grow:1;">
                                <i class="fas fa-file-export"></i>Export Project Storage
                            </button>
                            <div class="file-input-wrapper" style="flex-grow:1;">
                                <input type="file" id="importDedupeFile" accept=".json" onchange="handleImportDedupeFile(this)">
                                <div class="btn btn-outline file-display-text" id="fileDisplayText_importDedupe" style="width:100%; text-align:left; justify-content: flex-start;">
                                    <i class="fas fa-file-import"></i>Import to Project...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chapter Input Panel -->
            <div class="panel col-span-1 md-col-span-1">
                <h2 class="panel-title"><i class="fas fa-book-reader"></i>Chapter JSON Input</h2>
                <div id="chapterInputsContainer" style="max-height: 350px; overflow-y: auto; padding-right: 5px;">
                    <!-- Chapter input boxes dynamically added here -->
                </div>
                <div class="btn-group" style="margin-top:1rem;">
                    <button onclick="addChapterInputUI()" class="btn btn-secondary"> <!-- Changed to btn-secondary -->
                        <i class="fas fa-plus"></i>Add Chapter Box
                    </button>
                </div>
                <div id="jsonStatus" class="status-message" style="display:none; margin-top: 1rem;"></div>
            </div>

            <!-- Current Session Dedupe & Header Panel -->
            <div class="panel col-span-1 md-col-span-2"> <!-- Default md-col-span-2 for wider layouts -->
                <h2 class="panel-title"><i class="fas fa-filter"></i>Session Configuration</h2>
                <div class="session-config-grid-internal">
                    <div> <!-- Dedupe Column -->
                        <div class="form-group">
                            <label class="form-label">Current Session Deduplication List:</label>
                             <div class="file-input-wrapper">
                                <input type="file" id="csvFile" accept=".csv" onchange="updateFileDisplay(this, 'fileDisplayText_csv')">
                                <div class="file-display-text" id="fileDisplayText_csv"><i class="fas fa-file-csv"></i>Upload .csv file...</div>
                            </div>
                            <textarea id="pastedCsv" rows="3" placeholder="Or paste: raw,translation[,gender]"></textarea>
                            <div class="btn-group">
                                <button onclick="loadSessionDedupeList()" class="btn btn-secondary">
                                    <i class="fas fa-list-ul"></i>Load to Session
                                </button>
                                <div class="tooltip">
                                    <button onclick="copyToClipboard('pastedCsv', 'dedupeTooltip')" class="btn btn-outline btn-icon">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                    <span class="tooltip-text" id="dedupeTooltip">Copy List</span>
                                </div>
                                 <button onclick="clearSessionDedupeVisuals()" class="btn btn-outline btn-danger"><i class="fas fa-times"></i>Clear Inputs</button>
                            </div>
                            <div id="sessionDedupeStatus" class="status-message" style="display:none; margin-top: 0.5rem;"></div>
                        </div>
                    </div>
                    <div> <!-- Header Column -->
                        <div class="form-group">
                            <div style="display:flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <input type="checkbox" id="includeCustomHeaderCheckbox" onchange="toggleCustomHeaderInputUI(this.checked)" style="width:auto; height:auto; accent-color: var(--primary-500); transform: scale(1.1);">
                                <label for="includeCustomHeaderCheckbox" class="form-label" style="margin-bottom:0;">Include Custom Output Header</label>
                            </div>
                            <div id="customHeaderInputArea" style="display:none;">
                                <textarea id="editablePresetTextarea" rows="5" placeholder="Enter custom header text..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Extraction Actions & Results Panel -->
            <div class="panel col-span-3 md-col-span-2">
                <h2 class="panel-title"><i class="fas fa-magic-wand-sparkles"></i>Extraction Actions & Results</h2>
                <div style="text-align:center; margin-bottom: 1.5rem;">
                    <button id="mainExtractBtn" onclick="processAllData()" class="btn btn-primary btn-main-action">
                        <span class="spinner"></span>
                        <i class="fas fa-cogs"></i>Extract Terms
                    </button>
                </div>
                <div id="processingLog" class="status-message status-info" style="display:none; margin-bottom:1rem; flex-direction:column; align-items: flex-start;">
                    <strong>Processing Log:</strong>
                    <ul style="width:100%;"></ul>
                </div>

                <hr style="margin: 1.5rem 0; border-color: var(--neutral-200);">
                
                <div class="output-actions">
                    <div class="tooltip">
                        <button onclick="copyOutput('termsOnly')" class="btn btn-outline">
                            <i class="fas fa-clipboard-list"></i>Copy Terms Only
                        </button>
                        <span class="tooltip-text" id="copyTermsTooltip">Copy terms</span>
                    </div>
                    <div class="tooltip">
                         <button onclick="copyOutput('withHeader')" class="btn btn-outline">
                            <i class="fas fa-file-alt"></i>Copy with Header
                        </button>
                        <span class="tooltip-text" id="copyHeaderTooltip">Copy with header</span>
                    </div>
                </div>
                <div class="form-group">
                    <label for="outputTextarea" class="form-label">Extracted Terms:</label>
                    <textarea id="outputTextarea" rows="10" readonly placeholder="Extracted terms will appear here..."></textarea>
                </div>
                <div id="outputSummary" class="status-message" style="display:none;"></div>
                <div id="saveToStorageBtnContainer" style="margin-top: 1rem; text-align: right;">
                    <!-- "Save to [Novel Name] Storage" button will be dynamically added here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal-overlay" id="confirmationModal">
        <div class="modal-content">
            <h3 class="modal-title" id="modalTitle">Confirm Action</h3>
            <p class="modal-body" id="modalMessageText">Are you sure you want to proceed?</p>
            <div class="modal-actions">
                <!-- Buttons will be dynamically populated or handled by specific modal logic -->
                 <button class="btn btn-outline" id="modalCancelBtnGeneric">Cancel</button>
                 <button class="btn btn-danger" id="modalConfirmBtnGeneric">Confirm</button>
            </div>
        </div>
    </div>

    <footer style="text-align:center; padding: 2rem; color: var(--neutral-500); font-size: 0.875rem; margin-top:1.5rem;">
        <p>© 2024 Zenith Term Processor. Elevating Your Lexical Workflow.</p>
    </footer>

    <script>
    (function() { // IIFE Start
        // --- Global State & Constants ---
        let currentSessionDedupeTranslations = new Set(); 
        let persistentDedupeTranslations = new Set(); 
        let chapterInputCounter = 0;
        let lastExtractedPureTerms = []; 
        const LS_NOVEL_NAME_KEY = 'zenithTermExtractor_lastNovelName';
        const LS_DEDUPE_PREFIX = 'zenithTermExtractor_dedupe_';
        const LS_SIZE_WARNING_PREFIX = 'zenithTermExtractor_sizeWarning_';
        const STORAGE_WARNING_THRESHOLD_BYTES = 3.5 * 1024 * 1024; // 3.5MB

        const DEFAULT_HEADER_TEXT = `"Before replying YOU must think. From now onwards, in your thinking process/thought process/strategizing instead of YOU doing regular thinking, it is imperative that YOU MUST open and activate "Super-Duper-Hyper Thinking Mode". In this mode, you are obligated to: 1) engage in extreme exceptionally extreme thinking 2) engage in extreme exceptionally extreme extensivity 3) extreme exceptionally extreme extensity analysis."\n Go through the whole chat and check what have you translated these in your translation. add pinyin, where and its description and gender about it too. Mention if the  term is not present or cut in half. compare to my translation and let me know the difference reason.`;

        // --- DOM Elements ---
        const novelNameInput = document.getElementById('novelNameInput');
        const editablePresetTextarea = document.getElementById('editablePresetTextarea');
        const outputTextarea = document.getElementById('outputTextarea');
        const modalOverlay = document.getElementById('confirmationModal');
        const modalTitleEl = document.getElementById('modalTitle');
        const modalMessageEl = document.getElementById('modalMessageText');
        const modalActionsContainer = modalOverlay.querySelector('.modal-actions');
        let generalConfirmCallback = null;
        let generalCancelCallback = null;


        // --- Utility Functions ---
        function debounce(func, delay) {
            let timeoutId;
            return function(...args) {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => {
                    func.apply(this, args);
                }, delay);
            };
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            addChapterInputUI(); 
            editablePresetTextarea.value = DEFAULT_HEADER_TEXT;
            const lastNovel = localStorage.getItem(LS_NOVEL_NAME_KEY);
            if (lastNovel) {
                novelNameInput.value = lastNovel;
            }
            // Initial call for button labels and storage info
            updateDynamicButtonLabels(); 
            updateStoredTermsInfo();

            // Debounced listener for novel name input
            novelNameInput.addEventListener('keyup', debounce(updateDynamicButtonLabelsAndInfo, 350));

            // Generic Modal event listeners
            document.getElementById('modalCancelBtnGeneric').addEventListener('click', () => {
                if(typeof generalCancelCallback === 'function') generalCancelCallback();
                hideGenericModal();
            });
            document.getElementById('modalConfirmBtnGeneric').addEventListener('click', () => {
                if(typeof generalConfirmCallback === 'function') generalConfirmCallback();
                hideGenericModal();
            });
        });
        
        function updateDynamicButtonLabelsAndInfo() {
            updateDynamicButtonLabels();
            updateStoredTermsInfo(); // Ensure this is also called
        }


        // --- UI Update Functions ---
        function addChapterInputUI() {
            chapterInputCounter++;
            const container = document.getElementById('chapterInputsContainer');
            const itemDiv = document.createElement('div');
            itemDiv.className = 'chapter-input-group';
            itemDiv.id = `chapterGroup_${chapterInputCounter}`;

            const headerDiv = document.createElement('div');
            headerDiv.className = 'chapter-header';
            const label = document.createElement('span');
            label.className = 'chapter-label';
            label.textContent = `Chapter ${chapterInputCounter} JSON`;
            headerDiv.appendChild(label);

            if (chapterInputCounter > 1) { 
                const removeBtn = document.createElement('button');
                removeBtn.innerHTML = '<i class="fas fa-minus-circle"></i>';
                removeBtn.className = 'btn btn-icon btn-outline btn-danger';
                removeBtn.style.padding = '0.3rem 0.5rem'; 
                removeBtn.title = 'Remove this chapter box';
                removeBtn.onclick = () => {
                    itemDiv.remove();
                };
                headerDiv.appendChild(removeBtn);
            }
            itemDiv.appendChild(headerDiv);

            const textarea = document.createElement('textarea');
            textarea.rows = 4;
            textarea.placeholder = `Paste JSON for Chapter ${chapterInputCounter}...`;
            textarea.id = `chapterJson_${chapterInputCounter}`; 
            itemDiv.appendChild(textarea);
            container.appendChild(itemDiv);
            container.scrollTop = container.scrollHeight;
        }
        window.addChapterInputUI = addChapterInputUI;

        function toggleCustomHeaderInputUI(isChecked) {
            document.getElementById('customHeaderInputArea').style.display = isChecked ? 'block' : 'none';
        }
        window.toggleCustomHeaderInputUI = toggleCustomHeaderInputUI;

        function updateDynamicButtonLabels() {
            const novelName = novelNameInput.value.trim() || "Project";
            document.getElementById('loadStoredBtn').innerHTML = `<i class="fas fa-cloud-download-alt"></i>Load Stored for '${novelName}'`;
            document.getElementById('clearStoredBtn').innerHTML = `<i class="fas fa-trash-alt"></i>Clear Storage for '${novelName}'`;
            document.getElementById('exportStoredBtn').innerHTML = `<i class="fas fa-file-export"></i>Export '${novelName}' Storage`;
            
            const importFileInput = document.getElementById('importDedupeFile');
            const importFileDisplayButton = document.getElementById('fileDisplayText_importDedupe');
            
            if (novelName === "Project" || !novelNameInput.value.trim()) {
                importFileInput.disabled = true;
                importFileDisplayButton.innerHTML = `<i class="fas fa-file-import"></i>Name Project to Import`;
                importFileDisplayButton.style.cursor = "not-allowed";
                importFileDisplayButton.classList.add('disabled'); // You might need a .disabled CSS class
            } else {
                importFileInput.disabled = false;
                if (!importFileInput.files || importFileInput.files.length === 0) {
                     importFileDisplayButton.innerHTML = `<i class="fas fa-file-import"></i>Import to '${novelName}'...`;
                } // else updateFileDisplay handles it
                importFileDisplayButton.style.cursor = "pointer";
                importFileDisplayButton.classList.remove('disabled');
            }

            if (novelNameInput.value.trim() && novelName !== "Project") {
                localStorage.setItem(LS_NOVEL_NAME_KEY, novelNameInput.value.trim());
            }
            // updateStoredTermsInfo(); // Called by the debounced wrapper
        }
        
        function updateStoredTermsInfo() {
            const novelName = novelNameInput.value.trim();
            const storedInfoDiv = document.getElementById('storedTermsInfo');
            if (!novelName) {
                storedInfoDiv.style.display = 'none';
                return;
            }
            const key = LS_DEDUPE_PREFIX + novelName;
            const storedData = JSON.parse(localStorage.getItem(key) || '[]');
            let mainInfo = `<div style="display:flex; align-items:center; gap:0.5rem;"><i class="fas fa-database"></i> ${storedData.length} terms stored for '${novelName}'.</div>`;
            
            const warningKey = LS_SIZE_WARNING_PREFIX + novelName;
            if (localStorage.getItem(warningKey) === 'true') {
                mainInfo += `<div class="status-message status-warning" style="margin-top:0.5rem; padding:0.5rem 0.75rem; font-size:0.8em;">
                                <i class="fas fa-hdd"></i><strong>Storage Alert:</strong> Project data is large.
                                Please <strong>export your storage regularly</strong> to prevent data loss due to browser limits.
                             </div>`;
                storedInfoDiv.classList.remove('status-info'); // Remove default class if warning exists
                storedInfoDiv.classList.add('status-warning'); // Make whole box warning color
            } else {
                 storedInfoDiv.classList.remove('status-warning');
                 storedInfoDiv.classList.add('status-info');
            }

            storedInfoDiv.innerHTML = mainInfo;
            storedInfoDiv.style.display = 'flex';
        }


        function displayStatus(elementId, message, type = 'info', icon = null) {
            const el = document.getElementById(elementId);
            if (!el) return;
            let iconHtml = '';
            if (icon) iconHtml = `<i class="fas ${icon}"></i>`;
            else { 
                if(type === 'success') iconHtml = '<i class="fas fa-check-circle"></i>';
                else if(type === 'warning') iconHtml = '<i class="fas fa-exclamation-triangle"></i>';
                else if(type === 'danger') iconHtml = '<i class="fas fa-times-circle"></i>';
                else iconHtml = '<i class="fas fa-info-circle"></i>';
            }
            el.innerHTML = `${iconHtml} ${message}`;
            el.className = `status-message status-${type}`; 
            el.style.display = 'flex';
        }
        function hideStatus(elementId) { 
            const el = document.getElementById(elementId);
            if (el) el.style.display = 'none'; 
        }

        function updateFileDisplay(input, displayId) {
            const display = document.getElementById(displayId); // This is the text span/div inside the button for import
            if (!display) return;
            const novelName = novelNameInput.value.trim() || "Project";

            if (input.files && input.files.length > 0) {
                const baseIcon = displayId === 'fileDisplayText_csv' ? 'fa-file-csv' : 'fa-file-import';
                display.innerHTML = `<i class="fas ${baseIcon}"></i> ${input.files[0].name}`;
                if(display.classList.contains('btn')) display.classList.add('has-file'); // If it's the button-like display
                else display.classList.add('has-file');
            } else {
                if (displayId === 'fileDisplayText_csv') {
                    display.innerHTML = `<i class="fas fa-file-csv"></i> Upload .csv file...`;
                } else if (displayId === 'fileDisplayText_importDedupe') {
                    if (novelName === "Project" || !novelNameInput.value.trim()) {
                         display.innerHTML = `<i class="fas fa-file-import"></i>Name Project to Import`;
                    } else {
                        display.innerHTML = `<i class="fas fa-file-import"></i>Import to '${novelName}'...`;
                    }
                }
                if(display.classList.contains('btn')) display.classList.remove('has-file');
                else display.classList.remove('has-file');
            }
        }
        window.updateFileDisplay = updateFileDisplay; 
        
        function addProcessingLogStep(message, type = 'info') {
            const logUl = document.querySelector('#processingLog ul');
            if(!logUl) return;
            document.getElementById('processingLog').style.display = 'flex'; // it's a flex container now
            const li = document.createElement('li');
            let iconClass = 'fa-info-circle'; 
            let iconColor = 'var(--neutral-500)';

            if (type === 'success') { iconClass = 'fa-check-circle'; iconColor = 'var(--success-500)';}
            else if (type === 'danger') { iconClass = 'fa-times-circle'; iconColor = 'var(--danger-500)';}
            else if (type === 'warning') { iconClass = 'fa-exclamation-triangle'; iconColor = 'var(--warning-500)';}
            
            li.innerHTML = `<i class="fas ${iconClass}" style="color:${iconColor};"></i> ${message}`;
            logUl.appendChild(li);
            logUl.scrollTop = logUl.scrollHeight;
        }
        function clearProcessingLog() { 
            const logUl = document.querySelector('#processingLog ul');
            if (logUl) logUl.innerHTML = '';
            document.getElementById('processingLog').style.display = 'none';
        }

        // --- LocalStorage Interaction ---
        function getPersistentDedupeSet(novelName) {
            if (!novelName) return new Set();
            const key = LS_DEDUPE_PREFIX + novelName;
            const storedArray = JSON.parse(localStorage.getItem(key) || '[]');
            return new Set(storedArray.map(term => String(term).toLowerCase())); 
        }

        function savePersistentDedupeSet(novelName, translationsSet) {
            if (!novelName) {
                displayStatus('outputSummary', "Novel name is required to save to storage.", 'danger');
                return false;
            }
            const key = LS_DEDUPE_PREFIX + novelName;
            const dataStr = JSON.stringify(Array.from(translationsSet));
            
            // Check storage size and set warning if needed
            const sizeInBytes = new TextEncoder().encode(dataStr).length;
            const warningKey = LS_SIZE_WARNING_PREFIX + novelName;
            if (sizeInBytes > STORAGE_WARNING_THRESHOLD_BYTES) {
                localStorage.setItem(warningKey, 'true');
            } else {
                localStorage.removeItem(warningKey); // Clear warning if size reduces
            }

            localStorage.setItem(key, dataStr);
            updateStoredTermsInfo(); // This will now pick up the warning if set
            return true;
        }
        
        function loadPersistentDedupe() {
            const novelName = novelNameInput.value.trim();
            if (!novelName) {
                displayStatus('storedTermsInfo', "Please enter a Novel/Project Name first.", 'warning', 'fa-exclamation-triangle');
                return;
            }
            persistentDedupeTranslations = getPersistentDedupeSet(novelName);
            displayStatus('storedTermsInfo', `${persistentDedupeTranslations.size} terms loaded from '${novelName}' storage. This will be used for the next extraction.`, 'success', 'fa-cloud-download-alt');
            updateStoredTermsInfo(); // To refresh any warnings
        }
        window.loadPersistentDedupe = loadPersistentDedupe;
        
        function confirmClearStorage() {
            const novelName = novelNameInput.value.trim();
            if (!novelName) {
                 displayStatus('storedTermsInfo', "Please enter a Novel/Project Name to clear its storage.", 'warning', 'fa-exclamation-triangle'); 
                return;
            }
            showGenericModal(
                `Clear Storage for '${novelName}'?`,
                `This will permanently delete all ${getPersistentDedupeSet(novelName).size} stored deduplication terms for this project. This action cannot be undone.`,
                () => { // onConfirm
                    localStorage.removeItem(LS_DEDUPE_PREFIX + novelName);
                    localStorage.removeItem(LS_SIZE_WARNING_PREFIX + novelName); // Also clear warning flag
                    persistentDedupeTranslations.clear(); 
                    displayStatus('storedTermsInfo', `Storage for '${novelName}' cleared successfully.`, 'success', 'fa-check-circle');
                    updateStoredTermsInfo();
                }
            );
        }
        window.confirmClearStorage = confirmClearStorage;

        function exportPersistentDedupe() {
            const novelName = novelNameInput.value.trim();
            if (!novelName) {
                displayStatus('storedTermsInfo', "Novel name is required to export storage.", 'warning', 'fa-exclamation-triangle');
                return;
            }
            const dedupeSet = getPersistentDedupeSet(novelName);
            if (dedupeSet.size === 0) {
                displayStatus('storedTermsInfo', `No terms stored for '${novelName}' to export.`, 'info', 'fa-info-circle');
                return;
            }

            const dataStr = JSON.stringify(Array.from(dedupeSet), null, 2);
            const dataBlob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(dataBlob);
            
            const exportFileDefaultName = `${novelName.replace(/[^a-z0-9]/gi, '_')}_dedupe_export.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', url);
            linkElement.setAttribute('download', exportFileDefaultName);
            document.body.appendChild(linkElement);
            linkElement.click();
            document.body.removeChild(linkElement);
            URL.revokeObjectURL(url);
            displayStatus('storedTermsInfo', `Exported ${dedupeSet.size} terms for '${novelName}'.`, 'success', 'fa-check-circle');
        }
        window.exportPersistentDedupe = exportPersistentDedupe;

        function handleImportDedupeFile(fileInput) {
            const novelName = novelNameInput.value.trim();
            const importDisplayId = 'fileDisplayText_importDedupe';

            if (!novelName) {
                displayStatus('storedTermsInfo', "Novel name is required to import storage.", 'warning', 'fa-exclamation-triangle');
                fileInput.value = ''; 
                updateFileDisplay(fileInput, importDisplayId); 
                return;
            }

            if (fileInput.files.length === 0) {
                updateFileDisplay(fileInput, importDisplayId);
                return;
            }
            const file = fileInput.files[0];
            updateFileDisplay(fileInput, importDisplayId);

            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const importedArray = JSON.parse(event.target.result);
                    if (!Array.isArray(importedArray) || !importedArray.every(item => typeof item === 'string')) {
                        displayStatus('storedTermsInfo', 'Invalid file content. Expected a JSON array of strings.', 'danger', 'fa-times-circle');
                        fileInput.value = ''; updateFileDisplay(fileInput, importDisplayId);
                        return;
                    }

                    const currentStoredSet = getPersistentDedupeSet(novelName);
                    const importedSet = new Set(importedArray.map(t => String(t).toLowerCase()));

                    showImportOptionsModal(novelName, currentStoredSet, importedSet, () => {
                        fileInput.value = ''; updateFileDisplay(fileInput, importDisplayId); // Reset on cancel/close
                    });

                } catch (e) {
                    displayStatus('storedTermsInfo', `Error parsing import file: ${e.message}`, 'danger', 'fa-times-circle');
                    fileInput.value = ''; updateFileDisplay(fileInput, importDisplayId);
                }
            };
            reader.onerror = function() {
                displayStatus('storedTermsInfo', 'Error reading import file.', 'danger', 'fa-times-circle');
                fileInput.value = ''; updateFileDisplay(fileInput, importDisplayId);
            };
            reader.readAsText(file);
        }
        window.handleImportDedupeFile = handleImportDedupeFile;


        // --- Session Dedupe Management ---
        function loadSessionDedupeList() {
            const fileInput = document.getElementById('csvFile');
            const pastedCsv = document.getElementById('pastedCsv').value;
            let localTermsLoaded = 0;
            currentSessionDedupeTranslations.clear(); 

            const processContent = (content) => {
                content.split('\n').forEach(line => {
                    const parts = line.split(',').map(part => part.trim());
                    if (parts.length >= 2 && parts[1]) {
                        currentSessionDedupeTranslations.add(parts[1].toLowerCase());
                        localTermsLoaded++;
                    }
                });
            };

            if (fileInput.files.length > 0) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    processContent(e.target.result);
                    displayStatus('sessionDedupeStatus', `Loaded ${localTermsLoaded} terms to current session from file.`, 'success');
                };
                reader.onerror = () => displayStatus('sessionDedupeStatus', 'Error reading file.', 'danger');
                reader.readAsText(fileInput.files[0]);
            } else if (pastedCsv.trim()) {
                processContent(pastedCsv);
                displayStatus('sessionDedupeStatus', `Loaded ${localTermsLoaded} terms to current session from pasted text.`, 'success');
            } else {
                displayStatus('sessionDedupeStatus', 'No session dedupe data provided.', 'info');
            }
        }
        window.loadSessionDedupeList = loadSessionDedupeList;
        
        function clearSessionDedupeVisuals() {
            const csvFileInput = document.getElementById('csvFile');
            csvFileInput.value = ''; 
            updateFileDisplay(csvFileInput, 'fileDisplayText_csv');
            document.getElementById('pastedCsv').value = '';
            currentSessionDedupeTranslations.clear(); 
            hideStatus('sessionDedupeStatus');
        }
        window.clearSessionDedupeVisuals = clearSessionDedupeVisuals;

        // --- Main Extraction Logic ---
        async function processAllData() {
            const extractBtn = document.getElementById('mainExtractBtn');
            extractBtn.classList.add('loading');
            extractBtn.disabled = true;
            clearProcessingLog();
            hideStatus('jsonStatus'); hideStatus('outputSummary');
            document.getElementById('saveToStorageBtnContainer').innerHTML = ''; 
            addProcessingLogStep('Extraction process initiated...', 'info');
            
            lastExtractedPureTerms = [];
            const chapterTextareas = document.querySelectorAll('#chapterInputsContainer textarea');
            if (chapterTextareas.length === 0 || Array.from(chapterTextareas).every(ta => !ta.value.trim())) {
                displayStatus('jsonStatus', "No chapter JSON provided.", 'warning');
                addProcessingLogStep('No chapter JSON data. Aborted.', 'danger');
                finalizeExtractionUI(extractBtn); return;
            }
            
            const combinedDedupeForRun = new Set([...persistentDedupeTranslations, ...currentSessionDedupeTranslations]);
            addProcessingLogStep(`Using ${combinedDedupeForRun.size} terms for deduplication (from storage & session).`, 'info');

            let allChunks = [];
            let chaptersParsedCount = 0;
            for (let i = 0; i < chapterTextareas.length; i++) {
                const chapterJsonStr = chapterTextareas[i].value;
                const chapterGroup = chapterTextareas[i].closest('.chapter-input-group');
                const boxNumber = chapterGroup ? chapterGroup.id.split('_')[1] : i + 1; // Get logical box number
                
                if (!chapterJsonStr.trim()) { addProcessingLogStep(`Chapter Box ${boxNumber} empty. Skipping.`, 'info'); continue; }
                addProcessingLogStep(`Parsing Chapter from Box ${boxNumber}...`, 'info');
                await new Promise(r => setTimeout(r, 10)); 
                try {
                    const parsedChapter = JSON.parse(chapterJsonStr);
                    let isValidStructure = true;
                    let structureErrorMsg = "";

                    if (!Array.isArray(parsedChapter)) {
                        isValidStructure = false;
                        structureErrorMsg = "Input is not a JSON array.";
                    } else if (parsedChapter.length > 0) {
                        const firstElement = parsedChapter[0];
                        if (typeof firstElement !== 'object' || firstElement === null) {
                            isValidStructure = false;
                            structureErrorMsg = "First element in array is not an object.";
                        } else if (!('terms' in firstElement)) {
                            isValidStructure = false;
                            structureErrorMsg = "First object in array is missing 'terms' key.";
                        } else if (!Array.isArray(firstElement.terms)) {
                            isValidStructure = false;
                            structureErrorMsg = "'terms' key is not an array.";
                        }
                    }
                    
                    if (!isValidStructure) {
                         addProcessingLogStep(`Chapter Box ${boxNumber}: Invalid JSON structure. ${structureErrorMsg} Skipped.`, 'warning'); continue;
                    }

                    allChunks.push(...parsedChapter);
                    chaptersParsedCount++;
                    addProcessingLogStep(`Chapter Box ${boxNumber}: Parsed ${parsedChapter.length} chunks.`, 'success');
                } catch (e) { 
                    addProcessingLogStep(`Chapter Box ${boxNumber}: Invalid JSON. Error: "${e.message}". Skipped.`, 'danger'); 
                }
            }

            if (chaptersParsedCount === 0) {
                displayStatus('jsonStatus', 'No chapters successfully parsed. Check JSON and Processing Log.', 'danger');
                addProcessingLogStep('Failed to parse any chapter data. Aborted.', 'danger');
                finalizeExtractionUI(extractBtn); return;
            }
            addProcessingLogStep(`${chaptersParsedCount} chapters parsed. Extracting terms...`, 'info');

            const seenThisRunTranslations = new Set();
            allChunks.forEach(chunk => {
                if (chunk && Array.isArray(chunk.terms)) {
                    chunk.terms.forEach(term => {
                        const raw = term.raw, translation = term.translation;
                        if (raw && translation) {
                            const translationKey = String(translation).toLowerCase(); 
                            if (!combinedDedupeForRun.has(translationKey) && !seenThisRunTranslations.has(translationKey)) {
                                seenThisRunTranslations.add(translationKey);
                                let gender = "Neuter"; 
                                if (term.tags && Array.isArray(term.tags)) {
                                    if (term.tags.includes("#male")) gender = "Male";
                                    else if (term.tags.includes("#female")) gender = "Female";
                                }
                                lastExtractedPureTerms.push(`${raw}, ${translation}, ${gender}`);
                            }
                        }
                    });
                }
            });

            addProcessingLogStep(`Found ${lastExtractedPureTerms.length} new unique terms.`, 'success');
            
            let finalOutputText = "";
            const includeHeader = document.getElementById('includeCustomHeaderCheckbox').checked;
            const headerText = editablePresetTextarea.value.trim();
            if (includeHeader && headerText) {
                finalOutputText += headerText + "\n\n";
            }
            finalOutputText += lastExtractedPureTerms.join('\n');
            outputTextarea.value = finalOutputText;

            if (lastExtractedPureTerms.length > 0) {
                 displayStatus('outputSummary', `Extraction complete: ${lastExtractedPureTerms.length} new unique terms found.`, 'success');
                 createSaveToStorageButton();
            } else {
                 displayStatus('outputSummary', 'Extraction complete. No new unique terms found based on current deduplication lists.', 'info');
            }
            finalizeExtractionUI(extractBtn);
        }
        window.processAllData = processAllData;

        function createSaveToStorageButton() {
            const novelName = novelNameInput.value.trim();
            const container = document.getElementById('saveToStorageBtnContainer');
            container.innerHTML = ''; 
            if (lastExtractedPureTerms.length > 0 && novelName && novelName !== "Project") {
                const btn = document.createElement('button');
                btn.className = 'btn btn-secondary';
                btn.innerHTML = `<i class="fas fa-save"></i> Save ${lastExtractedPureTerms.length} New Terms to '${novelName}' Storage`;
                btn.onclick = saveNewTermsToPersistentStorage;
                container.appendChild(btn);
            } else if (!novelName || novelName === "Project" && lastExtractedPureTerms.length > 0) {
                 const p = document.createElement('p');
                 p.className = 'status-message status-warning';
                 p.innerHTML = `<i class="fas fa-exclamation-circle"></i> Enter a valid Novel Name to enable saving new terms to persistent storage.`;
                 container.appendChild(p);
            }
        }
        
        function saveNewTermsToPersistentStorage() {
            const novelName = novelNameInput.value.trim();
            if (!novelName || novelName === "Project") {
                displayStatus('outputSummary', 'A valid Novel Name is required to save.', 'danger');
                return;
            }
            if (lastExtractedPureTerms.length === 0) {
                displayStatus('outputSummary', 'No new terms to save.', 'info');
                return;
            }

            const currentPersistentSet = getPersistentDedupeSet(novelName);
            let addedCount = 0;
            lastExtractedPureTerms.forEach(termLine => {
                const translationKey = termLine.split(',')[1]?.trim().toLowerCase();
                if (translationKey && !currentPersistentSet.has(translationKey)) {
                    currentPersistentSet.add(translationKey);
                    addedCount++;
                }
            });

            if (savePersistentDedupeSet(novelName, currentPersistentSet)) {
                if (novelName === novelNameInput.value.trim()) { // Check if this is the currently active project
                     persistentDedupeTranslations = new Set([...currentPersistentSet]);
                }
                displayStatus('outputSummary', `Successfully saved ${addedCount} new term translations to '${novelName}' storage. Total stored: ${currentPersistentSet.size}.`, 'success');
                document.getElementById('saveToStorageBtnContainer').innerHTML = '<p class="status-message status-success" style="justify-content:flex-end;"><i class="fas fa-check-circle"></i> New terms saved to storage!</p>';
            } else {
                displayStatus('outputSummary', `Failed to save new terms to '${novelName}' storage.`, 'danger');
            }
        }

        function finalizeExtractionUI(button) {
            button.classList.remove('loading');
            button.disabled = false;
        }

        // --- Copy to Clipboard ---
        function copyOutput(mode) {
            let textToCopy = "";
            let tooltipId = "";
            let baseText = lastExtractedPureTerms.join('\n');

            if (mode === 'termsOnly') {
                textToCopy = baseText;
                tooltipId = 'copyTermsTooltip';
            } else if (mode === 'withHeader') {
                textToCopy = baseText; 
                if (document.getElementById('includeCustomHeaderCheckbox').checked) {
                    const header = editablePresetTextarea.value.trim();
                    if (header) {
                        textToCopy = header + (textToCopy ? "\n\n" + textToCopy : ""); 
                    }
                }
                 tooltipId = 'copyHeaderTooltip';
            }
            
            if (!textToCopy.trim()) { 
                 showTooltipMessage(tooltipId, (mode === 'termsOnly' ? "No terms to copy!" : "Nothing to copy!")); return;
            }
            performCopy(textToCopy, tooltipId);
        }
        window.copyOutput = copyOutput;
        
        function copyToClipboard(elementId, tooltipId) { 
            const el = document.getElementById(elementId);
            if (!el.value || !el.value.trim()) {
                showTooltipMessage(tooltipId, "Nothing to copy!"); return;
            }
            performCopy(el.value, tooltipId);
        }
        window.copyToClipboard = copyToClipboard;

        function performCopy(text, tooltipId) {
            navigator.clipboard.writeText(text).then(() => {
                showTooltipMessage(tooltipId, "Copied!");
            }).catch(err => {
                console.error('Clipboard copy failed:', err);
                showTooltipMessage(tooltipId, "Copy Failed!");
            });
        }
        function showTooltipMessage(tooltipId, message) {
            const tooltip = document.getElementById(tooltipId);
            if (!tooltip) return;
            const originalText = tooltip.dataset.originalText || tooltip.textContent; 
            if (!tooltip.dataset.originalText) tooltip.dataset.originalText = originalText;

            tooltip.textContent = message;
            tooltip.style.visibility = 'visible'; 
            tooltip.style.opacity = '1';

            setTimeout(() => { 
                tooltip.textContent = tooltip.dataset.originalText;
                tooltip.style.visibility = 'hidden';
                tooltip.style.opacity = '0';
            }, 1500);
        }

        // --- Modal Logic ---
        function showGenericModal(title, message, onConfirm, onCancel = null) {
            modalTitleEl.textContent = title;
            modalMessageEl.innerHTML = message; // Use innerHTML for potential formatting
            
            modalActionsContainer.innerHTML = ''; // Clear previous buttons

            const confirmBtn = document.createElement('button');
            confirmBtn.className = 'btn btn-danger';
            confirmBtn.textContent = 'Confirm';
            confirmBtn.onclick = () => { if(onConfirm) onConfirm(); hideGenericModal(); };
            
            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'btn btn-outline';
            cancelBtn.textContent = 'Cancel';
            cancelBtn.onclick = () => { if(onCancel) onCancel(); hideGenericModal(); };

            modalActionsContainer.appendChild(cancelBtn);
            modalActionsContainer.appendChild(confirmBtn);
            
            modalOverlay.classList.add('active');
        }

        function hideGenericModal() {
            modalOverlay.classList.remove('active');
            generalConfirmCallback = null;
            generalCancelCallback = null;
        }

        function showImportOptionsModal(novelName, currentSet, importedSet, onCancelOrClose) {
            modalTitleEl.textContent = `Import Terms for '${novelName}'`;
            const currentCount = currentSet.size;
            const importCount = importedSet.size;
            const mergedSet = new Set([...currentSet, ...importedSet]);
            const mergedCount = mergedSet.size;
            const newTermsInMerge = mergedCount - currentCount;

            modalMessageEl.innerHTML = `
                You are importing <strong>${importCount} unique terms</strong>.
                Your project '${novelName}' currently has <strong>${currentCount} stored terms</strong>.
                <br><br>Please choose an import action:
            `;
            
            modalActionsContainer.innerHTML = ''; // Clear previous buttons

            const replaceBtn = document.createElement('button');
            replaceBtn.className = 'btn btn-danger';
            replaceBtn.innerHTML = `<i class="fas fa-exchange-alt"></i> Replace (${importCount} total)`;
            replaceBtn.onclick = () => {
                savePersistentDedupeSet(novelName, importedSet);
                if (novelName === novelNameInput.value.trim()) persistentDedupeTranslations = new Set(importedSet);
                displayStatus('storedTermsInfo', `Successfully replaced storage. ${importedSet.size} terms now stored for '${novelName}'.`, 'success');
                updateStoredTermsInfo();
                hideGenericModal();
                if(onCancelOrClose) onCancelOrClose();
            };

            const mergeBtn = document.createElement('button');
            mergeBtn.className = 'btn btn-primary';
            mergeBtn.innerHTML = `<i class="fas fa- Mearge"></i> Merge (+${newTermsInMerge} new, ${mergedCount} total)`;
            mergeBtn.onclick = () => {
                savePersistentDedupeSet(novelName, mergedSet);
                 if (novelName === novelNameInput.value.trim()) persistentDedupeTranslations = new Set(mergedSet);
                displayStatus('storedTermsInfo', `Successfully merged terms. ${mergedCount} terms now stored for '${novelName}'. Added ${newTermsInMerge} new.`, 'success');
                updateStoredTermsInfo();
                hideGenericModal();
                if(onCancelOrClose) onCancelOrClose();
            };
            
            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'btn btn-outline';
            cancelBtn.textContent = 'Cancel Import';
            cancelBtn.onclick = () => { 
                hideGenericModal(); 
                if(onCancelOrClose) onCancelOrClose();
            };
            
            modalActionsContainer.appendChild(cancelBtn);
            modalActionsContainer.appendChild(mergeBtn);
            modalActionsContainer.appendChild(replaceBtn);
            
            modalOverlay.classList.add('active');
        }
        
    })(); // IIFE End
    </script>
</body>
</html>
